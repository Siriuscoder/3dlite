#version 330

uniform sampler2D fragMap;
uniform sampler2D normalMap;
uniform vec3 eye;

struct lightSource 
{
    int enabled;
    int type;
    vec3 position;
    vec3 ambient;
    vec3 diffuse;
    vec3 specular;
    vec3 direction;
    vec3 spotfactor;
    vec4 attenuation;
};

uniform lightSource light;

in vec2 iuv;

const float wrapAroundFactor = 0.1;
const float specPower = 40.0;

vec3 blinn_single(int type, vec3 lightDir, vec3 eyeDir, vec3 ambient, vec3 diffuse, 
    vec3 specular, vec3 normal, vec3 spotDirection, vec2 spotFactor, vec3 attenuation, 
    float specularFactor, float wrapAroundFactor, float specPower, inout vec3 linearSpec);

void main()
{
    if (light.enabled == 0)
        discard;

    /* fragment coordinate */
    vec3 frag = texture2D(fragMap, iuv).xyz;
    /* sampling normal and specular factor (w)*/
    vec4 normal = texture2D(normalMap, iuv);

    vec3 lightDir = light.position - frag;
    /* check light distance */
    if (length(lightDir) > 1000)
        discard;

    /* calculate direction from fragment to eye */
    vec3 eyeDir = normalize(eye - frag);

    vec3 linearSpec;
    vec3 linear = blinn_single(light.type, lightDir, eyeDir, light.ambient, light.diffuse, light.specular, normal.xyz, 
        light.direction, light.spotfactor.xy, vec3(0.7, 0.01, 0.00001), normal.w, wrapAroundFactor, specPower, linearSpec);

    /* result color in HDR */
    gl_FragColor = vec4(linear, 1.0);
}