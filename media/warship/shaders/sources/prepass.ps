#version 330

uniform sampler2D diffuse;
uniform sampler2D normals;
uniform int Gamma;

in vec2 iuv;
in vec4 ivv;
in mat3 itbn;

void main()
{
    // sampling normal from normal map
    vec4 nval = texture2D(normals, iuv);
    // put normal in [-1,1] range in tangent space 
    // and trasform normal to world space 
    vec3 nw = normalize(itbn * normalize(2*nval.rgb-1));
    // sampling diffuse color 
    vec4 fragDiffuse = texture2D(diffuse, iuv);
    // transform color from srgb to linear space
    if (Gamma > 0)
    {
        float gammaFactor = 2.2;
        fragDiffuse.rgb = pow(fragDiffuse.rgb, vec3(gammaFactor));
    }

    gl_FragData[0] = ivv / ivv.w;
    gl_FragData[1] = vec4(nw, nval.a);
    gl_FragData[2] = fragDiffuse;
}